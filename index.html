<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>底値管理アプリ</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .container { display: flex; gap: 40px; }
  .column { 
    flex: 1; 
    border: 2px solid #ccc; 
    border-radius: 8px; 
    padding: 15px; 
    background-color: #fafafa;
  }
  label { display: block; margin: 10px 0; }
  input[readonly] { background-color: #f0f0f0; }
  button { margin-top: 20px; padding: 5px 15px; }
  h2 { margin-top: 0; }
  .loading { color: #888; font-style: italic; }
</style>
</head>
<body>
<h1>底値管理アプリ</h1>

<label>
    品目：
    <input list="items" name="item" id="itemInput" required />
    <datalist id="items"></datalist>
</label>

<div class="container">
  <!-- 左側：参照エリア -->
  <div class="column">
    <h2>参照情報（底値）</h2>
    <div id="refStatus" class="loading"></div>
    <label>価格：<input type="number" id="refPrice" readonly></label>
    <label>数量：<input type="number" id="refQty" readonly></label>
    <label>単価：<input type="number" id="refUnitPrice" readonly></label>
  </div>

  <!-- 右側：入力エリア -->
  <div class="column">
    <h2>入力情報</h2>
    <label>価格：<input type="number" id="inputPrice"></label>
    <label>数量：<input type="number" id="inputQty"></label>
    <label>単価：<input type="number" id="inputUnitPrice" readonly></label>
    <button id="updateBtn" disabled>底値更新</button>
  </div>
</div>

<script>
const API_BASE = "https://usefultools.onrender.com"; // FastAPIのURLに置き換えてください

// 初期化：品目リスト取得
async function loadItems() {
  const res = await fetch(`${API_BASE}/items`);
  const items = await res.json();
  const dl = document.getElementById("items");
  dl.innerHTML = "";
  items.forEach(it => {
    const opt = document.createElement("option");
    opt.value = it;
    dl.appendChild(opt);
  });
}

// 品目選択/入力時に詳細取得
document.getElementById("itemInput").addEventListener("change", async () => {
  const itemName = document.getElementById("itemInput").value.trim();
  if (!itemName) return;

  // 読み込み中表示
  document.getElementById("refStatus").textContent = "読み込み中...";
  document.getElementById("refPrice").value = "";
  document.getElementById("refQty").value = "";
  document.getElementById("refUnitPrice").value = "";

  try {
    const res = await fetch(`${API_BASE}/item_detail?item=${encodeURIComponent(itemName)}`);
    const detail = await res.json();
    alert(detail.error);

    if (!detail.error) {
      document.getElementById("refPrice").value = detail.price || "";
      document.getElementById("refQty").value = detail.quantity || "";
      document.getElementById("refUnitPrice").value = detail.unit_price || "";
      document.getElementById("refStatus").textContent = ""; // 取得完了で消す
    } else {
      document.getElementById("refStatus").textContent = "該当データなし";
    }
  } catch (err) {
    document.getElementById("refStatus").textContent = "取得失敗";
  }
  checkUpdateButton();
});

// 入力単価自動計算
["inputPrice", "inputQty"].forEach(id => {
  document.getElementById(id).addEventListener("input", () => {
    const price = parseFloat(document.getElementById("inputPrice").value) || 0;
    const qty = parseFloat(document.getElementById("inputQty").value) || 0;
    const unit = qty > 0 ? (price / qty).toFixed(2) : "";
    document.getElementById("inputUnitPrice").value = unit;
    checkUpdateButton();
  });
});

// 更新ボタン有効化判定
function checkUpdateButton() {
  const inputUnit = parseFloat(document.getElementById("inputUnitPrice").value) || Infinity;
  const refUnit = parseFloat(document.getElementById("refUnitPrice").value) || Infinity;
  document.getElementById("updateBtn").disabled = !(inputUnit < refUnit);
}

// 更新ボタンクリック
document.getElementById("updateBtn").addEventListener("click", async () => {
  const itemName = document.getElementById("itemInput").value.trim();
  const payload = {
    item: itemName,
    price: parseFloat(document.getElementById("inputPrice").value),
    quantity: parseFloat(document.getElementById("inputQty").value),
    newItemMode: !(document.querySelector(`#items option[value="${itemName}"]`))
  };
  const res = await fetch(`${API_BASE}/update`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  alert("更新結果: " + JSON.stringify(await res.json()));
  loadItems();
});

// ページ初期化
loadItems();
</script>
</body>
</html>
